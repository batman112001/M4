<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Download & Extract</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</head>
<body>
  <div class="container">
    <h2>üîë Secure File Download</h2>
    <input type="text" id="fileId" placeholder="Enter File ID">
    <input type="password" id="password" placeholder="Enter ZIP Password">
    <button onclick="startDownload()">Download & Extract</button>
    <div id="status"></div>
  </div>

  <script>
    async function startDownload() {
      const fileId = document.getElementById("fileId").value.trim();
      const password = document.getElementById("password").value.trim();
      const status = document.getElementById("status");

      if (!fileId || !password) {
        alert("‚ùå Enter both File ID and Password");
        return;
      }

      status.textContent = "‚¨áÔ∏è Fetching file...";

      try {
        // 1. Get file URL from API
        let metaRes = await fetch(`/api/file?id=${fileId}`);
        let meta = await metaRes.json();
        if (!meta.url) throw new Error("File ID not found");

        // 2. Fetch actual file via proxy
        let res = await fetch(`/api/proxy?id=${fileId}`);
        if (!res.ok) throw new Error("File fetch failed");

        let blob = await res.blob();
        let arrayBuffer = await blob.arrayBuffer();

        // 3. Load & decrypt ZIP
        status.textContent = "üîì Decrypting ZIP...";
        let zip = new JSZip();
        await zip.loadAsync(arrayBuffer, { password });

        // 4. Extract & auto-download files
        status.textContent = "üìÇ Extracting files...";
        let files = Object.keys(zip.files);

        for (let filename of files) {
          let content = await zip.files[filename].async("blob");
          let link = document.createElement("a");
          link.href = URL.createObjectURL(content);
          link.download = filename;
          link.style.display = "none";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }

        status.textContent = "‚úÖ Extraction complete! Files downloaded.";
      } catch (err) {
        status.textContent = "‚ùå Error: " + err.message;
      }
    }
  </script>
</body>
</html>
