<script src="https://gildas-lormeau.github.io/zip.js/demos/zip-no-worker.min.js"></script>
<script>
async function downloadAndExtract(fileId, password) {
  try {
    // Step 1: fetch file URL from KV
    const res = await fetch(`/api/file?id=${fileId}`);
    const { url } = await res.json();

    // Step 2: proxy download
    const proxyRes = await fetch(`/api/proxy?url=${encodeURIComponent(url)}`);
    if (!proxyRes.ok) throw new Error("Failed to fetch file");
    const blob = await proxyRes.blob();

    // Step 3: open ZIP with password
    const reader = new zip.ZipReader(new zip.BlobReader(blob));
    const entries = await reader.getEntries();

    for (let entry of entries) {
      if (entry.filename.endsWith("/")) continue; // skip folders

      const writer = new zip.BlobWriter();
      const extracted = await entry.getData(writer, { password });
      const fileBlob = await extracted;

      // Offer download to user
      const link = document.createElement("a");
      link.href = URL.createObjectURL(fileBlob);
      link.download = entry.filename;
      link.click();
    }

    await reader.close();
  } catch (err) {
    alert("âŒ Extraction failed: " + err.message);
  }
}

// Example: after user enters fileId + password
document.getElementById("downloadBtn").addEventListener("click", () => {
  const fileId = document.getElementById("fileId").value.trim();
  const password = document.getElementById("zipPass").value.trim();
  downloadAndExtract(fileId, password);
});
</script>
